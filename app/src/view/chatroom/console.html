<!DOCTYPE HTML>
<html>
<head>
    <title>Websocket chat</title>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function(){
                var ws = 
                new WebSocket('ws://' + window.location.host + '/websocket/chat_protocol');
            ws.onopen = function() {
                    ws.send( JSON.stringify( {_type:"state",_state:"start"} )); 
                };
            ws.onmessage = function (msg) {
                try {
               msg =  JSON.parse(msg.data)

               if(msg._type == "message"){
               $('#log').append('<br>RCV:"' + msg._message + '",' + ' from: ' + msg._user );
               }
               else if ( msg._type == "state" ) {
               $('#log').append('<br>Received state update :' + msg._state  );
               }
               else {
               $('#log').append('<br>Received unknown message:"' + msg);
               }
                }catch(err) {
               $('#log').append('<br>Received non-js message:"' + msg);
                }

            };
            $('form#chat').submit(function(event) {
                _user =  $('#user').val();
                _message =  $('#message').val();
                ws.send( JSON.stringify( { type:"message", user : _user, message : _message  }  ) );
                return false;
            });
       });
    </script>
</head>
<body>
    <h2>Send:</h2>
    <form id="chat" method="POST" action='#'>
    <fieldset>
            <legend>Send message</legend>
            <p><label for="user">User</label><input type="text" name="user" id="user" value="{{user}}"></input></p>
            <p><label for="message">Message</label><textarea rows="10" cols="30"  name="message" id="message"></textarea></p>
    </fieldset>
        <input type="submit" value="send">
    </form>
    <h2>Receive:</h2>
    <div id="log"></div>
</body>
</html>
